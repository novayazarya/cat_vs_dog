# CAT vs DOG

Модель классификации кошек и собак на основе простой нейронной сети и веб-приложение.

## Данные

Обработанный датасет изображений кошек и собак https://storage.googleapis.com/mledu-datasets/cats_and_dogs_filtered.zip

## Инструменты и библиотеки

 - Модель: python 3.8.5, jupyter notebook, tensorflow 2.4.1, keras 2.4.3;
 - Веб-приложение: nginx, gunicorn 20.0.4, flask 1.1.2.

## Короткий гид по развертыванию веб-приложения

На примере VPS с операционной системой Linux Ubuntu 18.04.

### Шаг 1. Установка и настройка Nginx

```bash
sudo apt update
sudo apt install nginx
```

#### Настройка брандмауэра

Нужно разрешить HTTP-трафик через порт 80.

```bash
sudo ufw allow 'Nginx HTTP'
```
Проверить, вступили ли изменения в силу.

```bash
sudo ufw status
```

#### Проверка веб-сервера

Убедиться, что служба запущена и работает.

```bash
systemctl status nginx
```

Вы можете получить доступ к целевой странице Nginx по умолчанию, чтобы убедиться, что программное обеспечение работает правильно, перейдя на IP-адрес вашего сервера. Если вы не знаете IP-адрес своего сервера, вы можете узнать его несколькими способами.

```bash
ip addr show eth0 | grep inet | awk '{ print $2; }' | sed 's/\/.*$//'
```

Получить внешний IP, видимый из вне.

```bash
curl -4 icanhazip.com
```
Набрав этот адрес в браузере, вы увидите посадочную страницу Nginx, это будет значить, что сервер работает правльно.

#### Управление процессом Nginx

Теперь, когда ваш веб-сервер настроен и работает, изучите некоторые основные команды управления.

Остановить веб-сервер:

```bash
sudo systemctl stop nginx
```

Чтобы внось запустить веб-сервер, когда он остановлен:

```bash
sudo systemctl start nginx
```

Чтобы перезапустить службу:


```bash
sudo systemctl restart nginx
```

Если вы просто вносите изменения в конфигурацию, можно перезагрузить службу, не разрывая соединения:

```bash
sudo systemctl reload nginx
```

По умолчанию Nginx настроен на автоматический запуск при загрузке сервера. Можно отключить это поведение:

```bash
sudo systemctl disable nginx
```

Чтобы снова включить запуск службы при старте сервера:

```bash
sudo systemctl enable nginx
```

### Шаг 2. Установка компонентов из хранилищ Ubuntu

Она включает установку pip, диспетчера пакетов Python, который будет управлять нашими компонентами Python. Также мы получим файлы разработки Python, необходимые для создания некоторых компонентов Gunicorn.

Вначале обновим локальный индекс пакетов и установим пакеты, которые позволят нам создать нашу среду Python. Мы установим пакет python3-pip, а также еще несколько пакетов и средств разработки, необходимых для создания надежной среды программирования:

```bash
sudo apt update
sudo apt install python3-pip python3-dev build-essential libssl-dev libffi-dev python3-setuptools
```

### Шаг 3. Создание виртуальной среды Python

Теперь мы настроим виртуальную среду, чтобы изолировать наше приложение Flask от других файлов Python в системе.

Для начала установим пакет python3-venv, который установит модуль `venv`:

```bash
sudo apt install python3-venv
```

Затем создадим родительский каталог для нашего проекта Flask. Перейдите в каталог после его создания:

```bash
mkdir ~/myproject
cd ~/myproject
```

Создайте виртуальную среду для хранения требований Python для вашего проекта Flask:

```bash
python3 -m venv myprojectenv
```
Локальные копии Python и pip будут установлены в каталог myprojectenv в каталоге вашего проекта.

Прежде чем устанавливать приложения в виртуальной среде, ее нужно активировать:

```bash
source myprojectenv/bin/activate
```

### Шаг 4. Настройка приложения Flask

Находясь в виртуальной среде, вы можете установить Flask и Gunicorn и начать работу над созданием вашего приложения.

Вначале мы установим wheel с локальным экземпляром pip, чтобы убедиться, что наши пакеты будут устанавливаться даже при отсутствии архивов wheel:

```bash
pip install wheel
```

Затем установим Flask и Gunicorn:

```bash
pip install gunicorn flask
```

Чтобы протестировать приложение, вам нужно разрешить доступ к порту 5000:

```bash
sudo ufw allow 5000
```

Теперь вы можете протестировать приложение Flask:

```bash
python app.py
```bash

Откройте в браузере IP-адрес вашего сервера с суффиксом :5000: http://your_server_ip:5000

После того как вы убедитесь, что приложение запускается, нажмите `CTRL+C` в окне терминала, чтобы остановить сервер.

#### Создание точки входа WSGI

Теперь создадим файл, который будет служить точкой входа в наше приложение. Это покажет серверу Gunicorn, как взаимодействовать с приложением. Мы назовем этот файл wsgi.py:

```bash
nano ~/myproject/wsgi.py
```

Сейчас мы импортируем экземпляр Flask из нашего приложения в этот файл и запустим его:

```python
from app import app

if __name__ == "__main__":
    app.run()
```

Сохраните файл и закройте его после завершения.

### Шаг 5. Настройка Gunicorn

Точка входа для приложения создана, можем перейти к настройке Gunicorn.

Прежде чем продолжить, нужно убедиться, что Gunicorn может правильно обслуживать приложение.

Для этого нужно просто передать имя нашей точки входа. Оно составляется из имени модуля (без расширения .py) и имени вызываемого элемента приложения. В нашем случае это wsgi:app.

Также мы укажем интерфейс и порт для привязки, чтобы приложение запускалось через общедоступный интерфейс:

```bash
cd ~/myproject
gunicorn --bind 0.0.0.0:5000 wsgi:app
```

Откройте в браузере IP-адрес вашего сервера с суффиксом :5000: http://your_server_ip:5000.

Убедившись в его нормальной работе, нажмите `CTRL+C` в окне терминала.

Мы закончили работу с виртуальной средой, и теперь можем отключить ее:

```bash
deactivate
````

Теперь любые команды Python снова будут использовать системную среду Python.

Далее мы созадим файл служебных элементов systemd. Создание файла элементов systemd позволит системе инициализации Ubuntu автоматически запускать Gunicorn и обслуживать приложение Flask при загрузке сервера.

Для начала создайте файл элементов с расширением .service в каталоге /etc/systemd/system:

```bash
sudo nano /etc/systemd/system/myproject.service
```

Мы начнем с раздела [Unit] этого файла, где указываются метаданные и зависимости. Здесь мы разместим описание службы и предпишем системе инициализации запускать ее только после достижения сетевой цели:

```nano
[Unit]
Description=Gunicorn instance to serve myproject
After=network.target
```

Теперь откроем раздел [Service]. Здесь указывается пользователь и группа, от имени которых мы хотим запустить данный процесс. Сделаем владельцем процесса учетную запись обычного пользователя, поскольку этот пользователь является владельцем всех соответствующих файлов. Также назначим владельцем группу www-data, чтобы упростить коммуникацию Nginx с процессом Gunicorn. Не забудьте заменить приведенное имя пользователя своим именем пользователя:

```nano
[Service]
User=username
Group=www-data
```

Теперь составим карту рабочего каталога и зададим переменную среды `PATH`, чтобы система инициализации знала, что исполняемые файлы этого процесса находятся в нашей виртуальной среде. Также укажем команду для запуска службы. Эта команда будет выполнять следующее:

 - Запуск 3 рабочих процессов (хотя вы можете изменить это при необходимости)
 - Создание и привязвка к файлу сокетов Unix `myproject.sock` в каталоге нашего проекта. Мы зададим значение umask 007, чтобы при создании файла сокета предоставлялся доступ для владельца и для группы, а любой другой доступ ограничивался
 - Укажите имя файла точки входа WSGI, а также вызываемый элемент Python в этом файле (`wsgi:app`)

Systemd требует, чтобы мы указывали полный путь исполняемого файла Gunicorn, установленного в нашей виртуальной среде.

Не забудьте заменить имя пользователя и пути проекта собственными данными:

```nano
WorkingDirectory=/home/username/myproject
Environment="PATH=/home/username/myproject/myprojectenv/bin"
ExecStart=/home/username/myproject/myprojectenv/bin/gunicorn --workers 3 --bind unix:myproject.sock -m 007 wsgi:app
```

Наконец, добавим раздел [Install]. Это покажет systemd, куда привязывать эту службу, если мы активируем ее запуск при загрузке. Нам нужно, чтобы эта служба запускалась во время работы обычной многопользовательской системы:

```nano
[Unit]
Description=Gunicorn instance to serve myproject
After=network.target

[Service]
User=sammy
Group=www-data
WorkingDirectory=/home/username/myproject
Environment="PATH=/home/username/myproject/myprojectenv/bin"
ExecStart=/home/username/myproject/myprojectenv/bin/gunicorn --workers 3 --bind unix:myproject.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target
```
Теперь служебный файл systemd готов. Сохраните и закройте его.

Теперь мы запустим созданную службу Gunicorn, и активируем ее запуск при загрузке системы:

```bash
sudo systemctl start myproject
sudo systemctl enable myproject
```
Проверим состояние:

```bash
sudo systemctl status myproject
```

### Шаг 6. Настройка Nginx для работы с запросами прокси-сервера

Сервер приложений Gunicorn должен быть запущен и ожидать запросы файла сокета в каталоге проекта. Теперь мы настроим Nginx для передачи веб-запросов на этот сокет. Для этого мы сделаем небольшие добавления в его файл конфигурации.

Вначале мы создадим новый файл конфигурации серверных блоков в каталоге Nginx sites-available. Назовем его myproject для соответствия:

```bash
sudo nano /etc/nginx/sites-available/myproject
```

Откройте серверный блок и укажите Nginx прослушивать порт по умолчанию 80. Также укажите использовать этот блок для запросов доменного имени нашего сервера.
Затем добавим блок расположения, соответствующий каждому запросу. В этот блок мы добавим файл proxy_params, определяющий некоторые общие параметры прокси, которые необходимо настроить. После этого запросы будут переданы на сокет, который мы определили с помощью директивы proxy_pass:

```nano
server {
    listen 80;
    server_name your_domain www.your_domain;

    location / {
        include proxy_params;
        proxy_pass http://unix:/home/sammy/myproject/myproject.sock;
    }
}
```

Сохраните файл и закройте его после завершения.

Чтобы активировать созданную конфигурацию серверных блоков Nginx, необходимо привязать файл к каталогу sites-enabled:

```bash
sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled
```

Когда файл будет находиться в этом каталоге, можно провести проверку на ошибки синтаксиса:

```bash
sudo nginx -t
```

Если ошибок обнаружено не будет, перезапустите процесс Nginx для чтения новой конфигурации:

```bash
sudo systemctl restart nginx
```

В заключение снова изменим настройки брандмауэра. Нам больше не потребуется доступ через порт 5000, и мы можем удалить это правило. Затем мы сможем разрешить полный доступ к серверу Nginx:

```bash
sudo ufw delete allow 5000
sudo ufw allow 'Nginx Full'
```

Теперь у вас должна быть возможность открыть доменное имя вашего сервера в браузере без указания порта: http://your_domain

Если будут обнаружены любые ошибки, проверьте следующее:

 - `sudo less /var/log/nginx/error.log`: проверяет журналы ошибок Nginx.
 - `sudo less /var/log/nginx/access.log`: проверяет журналы доступа Nginx.
 - `sudo journalctl -u nginx`: проверяет журналы процессов Nginx.
 - `sudo journalctl -u myproject`: проверяет журналы Gunicorn вашего приложения Flask.

### Шаг 7. Проверка результата работы приложения
